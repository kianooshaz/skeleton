# Wire Container Documentation

This project uses Google Wire for dependency injection to manage the web application's dependencies in a clean and maintainable way.

## Container Structure

The `WebContainer` is located in `internal/container/` and provides a centralized way to manage all application dependencies:

### Key Components

1. **WebContainer** (`internal/container/container.go`)
   - Main container that holds all dependencies
   - Provides `Start()`, `Stop()`, and `Close()` methods for lifecycle management
   - Contains: Config, Logger, Database, and WebService

2. **Wire Configuration** (`internal/container/wire.go`)
   - Defines provider functions for each dependency
   - Sets up dependency injection graph using Wire sets
   - Build tag `//go:build wireinject` ensures this file is only used during code generation

3. **Generated Code** (`internal/container/wire_gen.go`)
   - Auto-generated by Wire based on the wire.go configuration
   - Contains the actual `NewWebContainer()` implementation
   - Build tag `//go:build !wireinject` ensures this is used in production

## Dependencies Managed

### Configuration (`AppConfig`)

- Loads from `config.yaml` using koanf
- Validates using go-playground/validator
- Contains settings for: shutdown timeout, logger, REST server, PostgreSQL

### Logger (`*slog.Logger`)

- Structured logging using Go's standard slog
- Configurable level, format, and environment
- Includes source location when enabled

### Database (`*sql.DB`)

- PostgreSQL connection using lib/pq driver
- Connection pooling and health checks
- Configurable timeouts and SSL settings

### Web Service (`protocol.WebService`)

- Echo-based REST API server
- CORS, rate limiting, and middleware support
- Graceful shutdown capabilities

## Usage

### In Main Application

```go
func main() {
    // Create container with all dependencies wired
    c, err := container.NewWebContainer()
    if err != nil {
        log.Fatal(err)
    }
    defer c.Close()

    // Start all services
    if err := c.Start(); err != nil {
        log.Fatal(err)
    }

    // Handle graceful shutdown...
}
```

### Development Commands

```bash
# Generate wire code
make wire

# Build application
make build

# Test container (without database)
make test-container

# Run application
make run
```

## Wire Provider Functions

- `ProvideAppConfig()` - Loads and validates configuration
- `ProvideLogger()` - Creates structured logger
- `ProvideDatabase()` - Establishes database connection
- `ProvideWebService()` - Creates REST web service
- `ProvideWebContainer()` - Assembles final container

## Wire Sets

- `ConfigSet` - Configuration loading
- `LoggerSet` - Logger creation
- `DatabaseSet` - Database connection
- `WebServiceSet` - Web service setup
- `WebContainerSet` - Complete container assembly

## Benefits

1. **Dependency Injection**: Clean separation of concerns
2. **Compile-Time Safety**: Wire validates dependency graph at build time
3. **Easy Testing**: Individual components can be mocked
4. **Configuration Management**: Centralized config with validation
5. **Lifecycle Management**: Proper startup and shutdown handling

## Testing

The `cmd/test-container/` directory contains a simple test that demonstrates:

- Container creation
- Dependency validation
- Configuration loading
- Error handling when services are unavailable

Run with: `make test-container`

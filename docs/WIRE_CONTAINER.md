# Wire Container Documentation

This project uses Google Wire for dependency injection to manage the web application's dependencies in a clean and maintainable way.

## Container Structure

The `WebContainer` is located in `internal/container/` and provides a centralized way to manage all application dependencies:

### Key Components

1. **WebContainer** (`internal/container/container.go`)
   - Main container that holds all dependencies
   - Provides `Start()`, `Stop()`, and `Close()` methods for lifecycle management
   - Contains: Config, Logger, Database, and all business services

2. **Wire Configuration** (`internal/container/wire.go`)
   - Defines provider functions for each dependency
   - Sets up dependency injection graph using Wire sets
   - Build tag `//go:build wireinject` ensures this file is only used during code generation

3. **Generated Code** (`internal/container/wire_gen.go`)
   - Auto-generated by Wire based on the wire.go configuration
   - Contains the actual `NewWebContainer()` implementation
   - Build tag `//go:build !wireinject` ensures this is used in production

## Dependencies Managed

### Configuration (`AppConfig`)

- Loads from `config.yaml` using koanf
- Validates using go-playground/validator
- Contains settings for: shutdown timeout, logger, REST server, PostgreSQL, and all service configurations

### Logger (`*slog.Logger`)

- Structured logging using Go's standard slog
- Configurable level, format, and environment
- Includes source location when enabled

### Database (`*sql.DB`)

- PostgreSQL connection using lib/pq driver
- Connection pooling and health checks
- Configurable timeouts and SSL settings

### Business Services

All business services are automatically instantiated and injected:

- **UserService** - User management operations
- **OrganizationService** - Organization management operations
- **PasswordService** - Password authentication and management
- **UsernameService** - Username assignment and validation
- **AuditService** - Audit logging with background workers

### Web Service (`protocol.WebService`)

- Echo-based REST API server
- CORS, rate limiting, and middleware support
- Graceful shutdown capabilities
- All business services injected automatically

## Usage

### In Main Application

```go
func main() {
    // Create container with all dependencies wired
    c, err := container.NewWebContainer()
    if err != nil {
        log.Fatal(err)
    }
    defer c.Close()

    // Start all services
    if err := c.Start(); err != nil {
        log.Fatal(err)
    }

    // Handle graceful shutdown...
}
```

### Development Commands

```bash
# Generate wire code
make wire

# Build application
make build

# Test container (without database)
make test-container

# Run application
make run
```

## Wire Provider Functions

- `ProvideAppConfig()` - Loads and validates configuration
- `ProvideLogger()` - Creates structured logger
- `ProvideDatabase()` - Establishes database connection
- `ProvideUserService()` - Creates user service
- `ProvideOrganizationService()` - Creates organization service
- `ProvidePasswordService()` - Creates password service with config
- `ProvideUsernameService()` - Creates username service with config
- `ProvideAuditService()` - Creates audit service with background workers
- `ProvideServices()` - Aggregates all services for REST layer
- `ProvideWebService()` - Creates REST web service with all dependencies
- `ProvideWebContainer()` - Assembles final container

## Wire Sets

- `ConfigSet` - Configuration loading
- `LoggerSet` - Logger creation
- `DatabaseSet` - Database connection
- `ServiceSet` - All business services
- `WebServiceSet` - Web service setup
- `WebContainerSet` - Complete container assembly

## Benefits

1. **Dependency Injection**: Clean separation of concerns
2. **Compile-Time Safety**: Wire validates dependency graph at build time
3. **Easy Testing**: Individual components can be mocked
4. **Configuration Management**: Centralized config with validation
5. **Lifecycle Management**: Proper startup and shutdown handling
6. **Service Integration**: All services automatically wired to REST layer

## Configuration

The application configuration supports all services:

```yaml
app:
  shutdown_timeout: 30s
  logger:
    level: "info"
    format: "json"
    environment: "development"
    source_location: true
  rest_server:
    address: ":8080"
    # ... rest server config
  postgres:
    # ... database config
  password:
    min_length: 8
    cost: 12
    # ... password service config
  username:
    max_user_username_per_organization: 5
    # ... username service config
  audit:
    buffer_size: 1000
    worker_count: 3
```

## Testing

The `cmd/test-container/` directory contains a simple test that demonstrates:

- Container creation
- Dependency validation
- Configuration loading
- Service instantiation
- Error handling when services are unavailable

Run with: `make test-container`

## Adding New Services

To add a new service:

1. Create the service package with its interface in proto/
2. Implement the service in service/
3. Add a provider function in `wire.go`
4. Add the service to the `Services` struct in REST package
5. Add the service to `WebContainer` struct
6. Update the Wire sets
7. Run `make wire` to regenerate

## Architecture Benefits

- **Centralized Dependency Management**: All dependencies managed in one place
- **Type Safety**: Compile-time validation of dependency graph
- **Configuration Driven**: All services configured through YAML
- **Graceful Lifecycle**: Proper startup and shutdown handling
- **Testing Friendly**: Easy to mock individual services
- **Maintainable**: Clear separation of concerns
